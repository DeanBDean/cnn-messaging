<!DOCTYPE html>

<html>
<head>
  <title>websocket.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="amqp.html">
                  ./src/amqp.js
                </a>
              
                
                <a class="source" href="message.html">
                  ./src/message.js
                </a>
              
                
                <a class="source" href="messenger.html">
                  ./src/messenger.js
                </a>
              
                
                <a class="source" href="websocket.html">
                  ./src/websocket.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>websocket.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> events <span class="hljs-keyword">from</span> <span class="hljs-string">'events'</span>;
<span class="hljs-keyword">import</span> Messenger <span class="hljs-keyword">from</span> <span class="hljs-string">'./messenger'</span>;
<span class="hljs-keyword">import</span> Debug <span class="hljs-keyword">from</span> <span class="hljs-string">'debug'</span>;
<span class="hljs-keyword">const</span> debug = Debug(<span class="hljs-string">'cnn-messaging:messenger:websocket'</span>);

<span class="hljs-keyword">let</span> WebSocket;
<span class="hljs-keyword">let</span> uwsEnabled = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">try</span> {
    WebSocket = <span class="hljs-built_in">require</span>(<span class="hljs-string">'uws'</span>);
    uwsEnabled = <span class="hljs-literal">true</span>;
} <span class="hljs-keyword">catch</span> (e) {
    debug(<span class="hljs-string">`uws module not available. <span class="hljs-subst">${e}</span>. Disabling...`</span>);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>A performant websocket relay for messenger</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebsocketRelay</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">events</span>.<span class="hljs-title">EventEmitter</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>create a new instance of websocket relay</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">constructor</span>(params = {}) {
        <span class="hljs-keyword">super</span>();
        <span class="hljs-keyword">if</span> (!params.messenger || (!params.port &amp;&amp; !params.http)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'You must provide an instance of a messenger and a port for web socket server'</span>);
        }
        <span class="hljs-keyword">if</span> (params.port &amp;&amp; uwsEnabled) {
            <span class="hljs-keyword">this</span>.io = <span class="hljs-keyword">new</span> WebSocket.Server({
                <span class="hljs-attr">perMessageDeflate</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-attr">port</span>: params.port
            });
        }
        <span class="hljs-keyword">if</span> (params.http &amp;&amp; uwsEnabled) {
            <span class="hljs-keyword">this</span>.io = <span class="hljs-keyword">new</span> WebSocket.Server({
                <span class="hljs-attr">perMessageDeflate</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-attr">server</span>: params.http
            });
        }

        <span class="hljs-keyword">this</span>.messenger = params.messenger;
        <span class="hljs-keyword">this</span>.messenger.websocketRelay = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">this</span>.connectionCount = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.connections = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.observables = {};
        <span class="hljs-keyword">this</span>.subscriptions = {};
        <span class="hljs-keyword">this</span>.pingInterval = params.pingInterval;

        <span class="hljs-keyword">this</span>.io &amp;&amp; <span class="hljs-keyword">this</span>.io.on(<span class="hljs-string">'connection'</span>, (socket) =&gt; {
            <span class="hljs-keyword">this</span>.handleSocketConnection(socket);
        });

        <span class="hljs-keyword">this</span>.pingService = setInterval(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
            <span class="hljs-keyword">this</span>.sendPing();
        }, <span class="hljs-keyword">this</span>.pingInterval);

        <span class="hljs-keyword">this</span>.pingService.unref();
    }

    sendPing() {
        <span class="hljs-keyword">const</span> startTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
        <span class="hljs-keyword">this</span>.io &amp;&amp; <span class="hljs-keyword">this</span>.io.clients.forEach(<span class="hljs-function">(<span class="hljs-params">ws</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (ws.isAlive === <span class="hljs-literal">false</span>) {
                <span class="hljs-keyword">return</span> ws.terminate();
            }

            ws.isAlive = <span class="hljs-literal">false</span>;
            ws.ping(<span class="hljs-string">''</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);
        });
        <span class="hljs-keyword">const</span> endTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
        <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'pingComplete'</span>, {
            <span class="hljs-attr">connections</span>: <span class="hljs-keyword">this</span>.connections,
            <span class="hljs-attr">duration</span>: endTime - startTime
        });
    }

    handleSocketConnection(socket) {
        <span class="hljs-keyword">this</span>.connectionCount++;
        <span class="hljs-keyword">this</span>.connections++;

        socket.id = <span class="hljs-keyword">this</span>.connectionCount;
        debug(<span class="hljs-string">`socket <span class="hljs-subst">${socket.id}</span> connected`</span>);

        socket.isAlive = <span class="hljs-literal">true</span>;
        socket.on(<span class="hljs-string">'pong'</span>, () =&gt; {
            socket.isAlive = <span class="hljs-literal">true</span>;
        });

        socket.on(<span class="hljs-string">'message'</span>, (msg) =&gt; {
            <span class="hljs-keyword">this</span>.handleSocketMessage(socket, msg);
        });

        socket.on(<span class="hljs-string">'close'</span>, () =&gt; {
            <span class="hljs-keyword">this</span>.handleSocketClose(socket);
        });
    }

    handleSocketMessage(socket, msg) {
        <span class="hljs-keyword">let</span> request;
        <span class="hljs-keyword">try</span> {
            request = <span class="hljs-built_in">JSON</span>.parse(msg);
        } <span class="hljs-keyword">catch</span> (e) {
            debug(<span class="hljs-string">`Error parsing request <span class="hljs-subst">${msg}</span>`</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">switch</span> (request.action) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">'subscribe'</span>:
                <span class="hljs-keyword">this</span>.subscribe(request.topic, socket);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">'unsubscribe'</span>:
                <span class="hljs-keyword">this</span>.unsubscribe(request.topic, socket.id);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
                debug(<span class="hljs-string">`Got unknown request action: <span class="hljs-subst">${request.action}</span>`</span>);
        }
    }

    subscribe(topic, socket) {
        debug(<span class="hljs-string">`got subscribe request for <span class="hljs-subst">${topic}</span>`</span>);
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.observables[topic]) {
            <span class="hljs-keyword">this</span>.messenger.createNotificationObservable(topic)
                .then(<span class="hljs-function">(<span class="hljs-params">o</span>) =&gt;</span> {
                    <span class="hljs-keyword">this</span>.observables[topic] = o.subscribe(<span class="hljs-function">(<span class="hljs-params">message</span>) =&gt;</span> {
                        <span class="hljs-keyword">this</span>.relay(topic, message.toWS());
                    }, (err) =&gt; {
                        debug(err);
                    }, () =&gt; {
                        debug(<span class="hljs-string">'observable ended'</span>);
                    });
                });
        }
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.subscriptions[topic]) {
            <span class="hljs-keyword">this</span>.subscriptions[topic] = {};
        }
        <span class="hljs-keyword">this</span>.subscriptions[topic][socket.id] = socket;
    }

    unsubscribe(topic, socketId) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.subscriptions[topic][socketId]) {
            <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.subscriptions[topic][socketId];
            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.subscriptions[topic]).length) {
                <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.subscriptions[topic];
            }
        }
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.subscriptions[topic] &amp;&amp; <span class="hljs-keyword">this</span>.observables[topic]) {
            debug(<span class="hljs-string">`closing observable for <span class="hljs-subst">${topic}</span>`</span>);
            <span class="hljs-keyword">this</span>.observables[topic].unsubscribe();
            <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.observables[topic];
        }
    }

    handleSocketClose(socket) {
        <span class="hljs-keyword">this</span>.connections--;
        debug(<span class="hljs-string">`socket <span class="hljs-subst">${socket.id}</span> disconnected`</span>);
        <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.subscriptions).forEach(<span class="hljs-function">(<span class="hljs-params">topic</span>) =&gt;</span> {
            <span class="hljs-keyword">this</span>.unsubscribe(topic, socket.id);
        });
    }

    relay(topic, msg) {
        <span class="hljs-keyword">const</span> startTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
        <span class="hljs-keyword">let</span> subscribers = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.subscriptions[topic]) {
            <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.subscriptions[topic]).forEach(<span class="hljs-function">(<span class="hljs-params">socketId</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> socket = <span class="hljs-keyword">this</span>.subscriptions[topic][socketId];
                debug(<span class="hljs-string">'sending to websocket'</span>, socketId, topic, msg);
                socket.send(msg);
                subscribers++;
            });
        }
        <span class="hljs-keyword">const</span> endTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
        <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'relayComplete'</span>, {
            topic,
            subscribers,
            <span class="hljs-attr">duration</span>: endTime - startTime
        });
    }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> WebsocketRelay;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
